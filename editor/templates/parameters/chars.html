{% extends 'base.html' %}

{% block header %}
  <div class="d-flex justify-content-between align-items-center py-3 px-4 border-bottom">
    <div class="flex-grow-1 text-center">
      <h2 class="m-0">Characters</h2>
    </div>
    <div class="ms-auto">
      <a href="/createchar" class="btn btn-primary">Add</a>
    </div>
  </div>

{% endblock header %}

{% block content %}
<table id='charTable'>
  <thead>
    <th class="hide">id</th>
    <th>Name</th>
    <th>Description</th>
    <th>Created</th>
    <th class="button_col">Update</th>
    <th class="button_col">Delete</th>
  </thead>

  <tbody>

    {% for char in chars %}
      <tr id="row_{{char['char_id']}}">
        <td class="hide">{{char["char_id"]}}</td>
        <td>{{char["name"]}}</td>
        <td>{{char["description"]}}</td>
        <td>{{char["created"].strftime("%b %d, %Y at %I:%M%p")}}</td>

        <td class="button_col">
          <form method="post">
            <button type="submit" name="action" id="{{char['char_id']}}" value="{{char['char_id']}}" class="btn btn-secondary">
              <i class="bi bi-pen-fill"></i>
            </button>
          </form>
        </td>

        <td class="button_col">
          <button class='btn btn-danger btn-secondary deletebutton' type="button" id="{{char['char_id']}}">
            <i class="bi bi-trash-fill"></i>
          </button>
        </td>        

      </tr>
    {% endfor %}

  </tbody>
  </table>
 
  <div id="flash-container" style="margin-top: 20px;"</div>

  {{ macros.modal_box('confirmModal', 'Confirm Delete Character') }}

 <script>

    document.querySelectorAll('.deletebutton').forEach(button => {
      button.addEventListener('click', event => {
        var id = event.currentTarget.id;
        const row = document.getElementById(id)?.closest("tr");
        const title = row?.cells[1]?.textContent.trim();
        deleteClicked(id,deleteChar, title);
      });
    });

    function deleteChar(id) {
      $.ajax({
      url: "/deletechar",
      type: "post",
      data: {'char_id': id},
      dataType: 'json'}
      ).done(function(response) {
        console.log(response);
        var rowid = "row_" + id;
        var r = document.getElementById(rowid);
        var i = r.rowIndex;
        document.getElementById("charTable").deleteRow(i);
        if (response.messages) {
          response.messages.forEach(([category, message]) => {
          showFlashMessage(category, message);
          });
          }
       }).fail(function(error) {
        console.log(error);
      })
      }; 

  </script>


</table> 
{% endblock content %}