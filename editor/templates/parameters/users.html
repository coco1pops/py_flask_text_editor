{% extends 'base.html' %}

{% block header %}
<div class="d-flex justify-content-between align-items-center py-3 px-4 border-bottom">
  <div class="flex-grow-1 text-center">
    <h2 class="m-0">User</h2>
  </div>
  <div class="ms-auto">
    <a href="/createuser" class="btn btn-primary">Add</a>
  </div>
</div>
{% endblock header %}

{% block content %}
<table id='userTable'>
  <thead>
    <th>Id</th>
    <th>Name</th>
    <th>Role</th>
    <th class="button_col">Update</th>
    <th class="button_col">Delete</th>
  </thead>

  <tbody>

    {% for user in users %}
      <tr id="row_{{user['user_id']}}">
        <td>{{user["user_id"]}}</td>
        <td>{{user["user_name"]}}</td>
        <td>{{user["user_role"]}}</td>

        <td class="button_col">
          <form method="post">
            <button type="submit" name="action" id="{{user['user_id']}}" value="{{user['user_id']}}"
              class="btn btn-secondary">
              <i class="bi bi-pen-fill"></i>
            </button>
          </form>
        </td>

        <td class="button_col">
          <button class='btn btn-danger btn-secondary deletebutton' type="button" id="{{user['user_id']}}">
            <i class="bi bi-trash-fill"></i>
          </button>
        </td>

      </tr>
    {% endfor %}

  </tbody>

</table>

{{ macros.modal_box('confirmModal', 'Confirm Delete User') }}

<div id="flash-container" style="margin-top: 20px;" </div>


<script>

  document.querySelectorAll('.deletebutton').forEach(button => {
    button.addEventListener('click', event => {
      var id = event.currentTarget.id;
      const row = document.getElementById(id)?.closest("tr");
      const title = row?.cells[1]?.textContent.trim();
      deleteClicked(id,deleteUser, title);
    });
  });


  function deleteUser(id) {
    $.ajax({
      url: "/deleteuser",
      type: "post",
      data: { 'user_id': id },
      dataType: 'json'
    }).done(function (response) {
      console.log(response);
      var rowid = "row_" + id;
      var r = document.getElementById(rowid);
      var i = r.rowIndex;
      document.getElementById("userTable").deleteRow(i);
      if (response.messages) {
        response.messages.forEach(([category, message]) => {
          showFlashMessage(category, message);
        });
      }
    }).fail(function (error) {
      console.log(error);
    })
  };

</script>
{% endblock content %}